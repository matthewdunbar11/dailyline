name: Render Deploy

on:
  push:
    branches:
      - master
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

concurrency:
  group: render-deploy-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render production deploy
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_PRODUCTION_DEPLOY_HOOK_URL is not set"
            exit 1
          fi

          curl --fail --show-error --silent \
            --request POST \
            "$RENDER_DEPLOY_HOOK_URL"

  deploy-pr-preview:
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render preview deploy
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_PREVIEW_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_PREVIEW_DEPLOY_HOOK_URL is not set"
            exit 1
          fi

          curl --fail --show-error --silent \
            --request POST \
            --header "Content-Type: application/json" \
            --data '{"clearCache":"do_not_clear"}' \
            "$RENDER_DEPLOY_HOOK_URL"
